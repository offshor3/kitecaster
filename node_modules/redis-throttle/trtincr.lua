local key = KEYS[1]
local now = tonumber(KEYS[2])
local span = tonumber(KEYS[3])
 
local ttl = redis.call('pttl', key) 

local indices = {}
for i=0,15 do
  table.insert(indices, i)
end

if ttl < span then 
  if ttl > -1 then 
    local buckets = redis.call('hmget', key, unpack(indices)) 
    local new_buckets = {}
    for i=1,16 do
      table.insert(new_buckets, i-17)
      table.insert(new_buckets, tonumber(buckets[i]))
    end
    for i=0,15 do
      table.insert(new_buckets, i)
      table.insert(new_buckets, 0)
    end
    redis.call('hmset', key, unpack(new_buckets))
  end
  redis.call('pexpire', key, span * 2 - now % span) 
end 
 
local sum = 0
if (ttl != -1) then
  local buckets = redis.call('hmget', key, unpack(indices))

  for i=1,16 do 
    sum = sum + tonumber(buckets[i])
  end 
end
return sum

