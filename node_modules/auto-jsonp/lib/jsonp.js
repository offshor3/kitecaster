'use strict';

var express = require('express');

(function () {
  var oldGet = express.application.get;
  express.application.get = function () {
    var args = Array.prototype.slice.call(arguments);
    var useJSON = true;
    if (typeof args[1] === 'boolean') {
      useJSON = args[1];
      args = [args[0]].concat(args.slice(2));
    }
    if (typeof args[0] === 'string' && typeof args[1] === 'function' && useJSON) {
      oldGet.apply(this, [args[0] + '.json'].concat(args.slice(1)));
    }
    return oldGet.apply(this, args);
  };
}());

(function () {
  var oldRender = express.response.render;
  express.response.render = function () {
    if (!this.isJSON) {
      oldRender.apply(this, arguments);
      return;
    }
    var args = Array.prototype.slice.call(arguments);
    if (typeof args[0] === 'string') {
      args.shift();
    }
    this.jsonp.apply(this, args);
  };
}());

function middleware(req, res, next) {
  var path = req.path.split('?')[0];
  if (/\.json$/.test(path)) {
    res.isJSON = true;
  }
  next();
}

module.exports = middleware;
